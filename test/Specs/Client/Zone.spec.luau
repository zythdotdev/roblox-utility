return function()
	local Players = game:GetService("Players")
	local ReplicatedStorage = game:GetService("ReplicatedStorage")
	local Zone = require(ReplicatedStorage.Modules.Zone)

	local part
	local character
	local originalPosition

	beforeEach(function()
		part = Instance.new("Part")
		part.Size = Vector3.new(50, 50, 50)
		part.Position = Vector3.new(100, 100, 100)
		part.CanCollide = false
		part.CanTouch = true
		part.CanQuery = true
		part.Anchored = true
		part.Transparency = 0.8
		part.Parent = workspace

		character = Players.LocalPlayer.Character or Players.LocalPlayer.CharacterAdded:Wait()
		originalPosition = character:GetPivot()
	end)

	afterEach(function()
		if part then
			part:Destroy()
		end
		if character and originalPosition then
			character:PivotTo(originalPosition)
		end
	end)

	describe("Zone", function()
		it("Should create a new zone", function()
			local zone = Zone.new(part)
			expect(zone).to.be.ok()
			expect(zone.className).to.equal("Zone")
			zone:Destroy()
		end)
		it("Should create a zone with custom update interval", function()
			local zone = Zone.new(part, 0.5)
			expect(zone).to.be.ok()
			expect(zone._UpdateInterval).to.equal(0.5)
			zone:Destroy()
		end)
		it("Should enable tracking", function()
			local zone = Zone.new(part)
			zone:Enable()
			expect(zone._EnableTracking).to.equal(true)
			zone:Destroy()
		end)
		it("Should disable tracking", function()
			local zone = Zone.new(part)
			zone:Enable()
			zone:Disable()
			expect(zone._EnableTracking).to.equal(false)
			zone:Destroy()
		end)
		it("Should detect players added", function()
			local zone = Zone.new(part, 0.1)
			zone:Enable()
			character:PivotTo(part.CFrame)
			task.wait(0.5)
			local detected = zone:GetDetectedPlayers()
			expect(#detected).to.equal(1)
			zone:Destroy()
		end)
		it("Should detect players removed", function()
			local zone = Zone.new(part, 0.1)
			zone:Enable()
			character:PivotTo(part.CFrame)
			task.wait(0.5)
			character:PivotTo(CFrame.new(Vector3.new(0, 5, 0)))
			task.wait(0.5)
			local detected = zone:GetDetectedPlayers()
			expect(#detected).to.equal(0)
			zone:Destroy()
		end)
		it("Should fire PlayerAdded event when player enters zone", function()
			local zone = Zone.new(part, 0.1)
			zone:Enable()
			local playerAdded = false
			local addedPlayer = nil
			local connection = zone.PlayerAdded:Connect(function(player)
				playerAdded = true
				addedPlayer = player
			end)
			character:PivotTo(part.CFrame)
			task.wait(0.5)
			expect(playerAdded).to.equal(true)
			expect(addedPlayer).to.equal(Players.LocalPlayer)
			connection:Disconnect()
			zone:Destroy()
		end)
		it("Should fire PlayerRemoved event when player leaves zone", function()
			local zone = Zone.new(part, 0.1)
			zone:Enable()
			local playerRemoved = false
			local removedPlayer = nil
			local connection = zone.PlayerRemoved:Connect(function(player)
				playerRemoved = true
				removedPlayer = player
			end)
			character:PivotTo(part.CFrame)
			task.wait(0.5)
			character:PivotTo(CFrame.new(Vector3.new(0, 5, 0)))
			task.wait(0.5)
			expect(playerRemoved).to.equal(true)
			expect(removedPlayer).to.equal(Players.LocalPlayer)
			connection:Disconnect()
			zone:Destroy()
		end)
		it("Should fire Detected event when players are in zone", function()
			local zone = Zone.new(part, 0.1)
			zone:Enable()
			local detectedCount = 0
			local connection = zone.Detected:Connect(function()
				detectedCount += 1
			end)
			character:PivotTo(part.CFrame)
			task.wait(0.2)
			expect(detectedCount).to.never.equal(0)
			connection:Disconnect()
			zone:Destroy()
		end)
		it("Should not fire Detected event when disabled", function()
			local zone = Zone.new(part, 0.1)
			zone:Enable()
			local detectedCount = 0
			local connection = zone.Detected:Connect(function()
				detectedCount += 1
			end)
			character:PivotTo(part.CFrame)
			task.wait(0.3)
			zone:Disable()
			local countAfterDisable = detectedCount
			task.wait(0.3)
			expect(detectedCount).to.equal(countAfterDisable)
			connection:Disconnect()
			zone:Destroy()
		end)
		it("Should get detected humanoid root parts", function()
			local zone = Zone.new(part, 0.1)
			zone:Enable()
			task.wait(0.2)
			character:PivotTo(part.CFrame)
			task.wait(0.5)
			local rootParts = zone:GetDetectedHumanoidRootParts()
			expect(rootParts[Players.LocalPlayer]).to.be.ok()
			expect(rootParts[Players.LocalPlayer].Name).to.equal("HumanoidRootPart")
			zone:Destroy()
		end)
		it("Should clear detected players when disabled", function()
			local zone = Zone.new(part, 0.1)
			zone:Enable()
			character:PivotTo(part.CFrame)
			task.wait(0.5)
			zone:Disable()
			local detected = zone:GetDetectedPlayers()
			expect(#detected).to.equal(0)
			zone:Destroy()
		end)
		it("Should destroy zone properly", function()
			local zone = Zone.new(part)
			zone:Enable()
			zone:Destroy()
			expect(zone.PlayerAdded).to.equal(nil)
			expect(zone.PlayerRemoved).to.equal(nil)
			expect(zone.Detected).to.equal(nil)
		end)
		it("Should throw error when accessing destroyed zone", function()
			local zone = Zone.new(part)
			zone:Destroy()
			expect(function()
				zone:Enable()
			end).to.throw()
		end)
		it("Should throw error when getting players from destroyed zone", function()
			local zone = Zone.new(part)
			zone:Destroy()
			expect(function()
				zone:GetDetectedPlayers()
			end).to.throw()
		end)
		it("Should handle multiple enable calls gracefully", function()
			local zone = Zone.new(part)
			zone:Enable()
			zone:Enable()
			expect(zone._EnableTracking).to.equal(true)
			zone:Destroy()
		end)
		it("Should handle multiple disable calls gracefully", function()
			local zone = Zone.new(part)
			zone:Enable()
			zone:Disable()
			zone:Disable()
			expect(zone._EnableTracking).to.equal(false)
			zone:Destroy()
		end)
		it("Should stop tracking when all players leave", function()
			local zone = Zone.new(part, 0.1)
			zone:Enable()
			character:PivotTo(part.CFrame)
			task.wait(0.1)
			expect(zone._HeartbeatConnection).to.be.ok()
			character:PivotTo(CFrame.new(Vector3.new(0, 5, 0)))
			task.wait(0.3)
			expect(zone._HeartbeatConnection).to.equal(nil)
			zone:Destroy()
		end)
	end)
end